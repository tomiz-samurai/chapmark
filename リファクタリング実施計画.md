# ChapMarkアプリ リファクタリング実施計画

## 現状の問題点と課題

詳細な分析の結果、以下の主要な問題が特定されました：

1. ファイルサイズが大きく、複雑なコンポーネント（特にapp/(tabs)内のタブ画面）
2. 複数の場所で重複・不一致のある型定義
3. コンポーネント構造の不整合と論理的グループ化の欠如
4. Redux状態管理での型安全性の欠如（any型の多用）
5. サービスとコンポーネント間の責任分担の不明確さ

## 対応済みのリファクタリング

現在までに以下のリファクタリングを実施しました：

1. **型安全なReduxフック**
   - `useAppSelector`と`useAppDispatch`の作成
   - 型情報を保持したままRedux状態にアクセス可能

2. **TimerScreenコンポーネントの分割**
   - `TimerControls` - タイマー制御ボタン
   - `PageProgress` - ページ進捗入力
   - `CompletionModal` - 読書完了モーダル

3. **型定義の統一と集約**
   - `types/models/book.ts` - 統一された書籍モデル
   - インデックスファイルによる型定義のエクスポート

## 今後の実施計画

### フェーズ1: 型定義の統一と安全性向上（1-2週間）

1. **既存の型定義を全て`types`ディレクトリに移行**
   - `lib/types.ts`の内容を適切に分割
   - `types/book.ts`を`types/models/book.ts`に統合
   - `lib/services/BookService.ts`の型定義を適切に移行

2. **全てのコンポーネントで新しい型定義を使用**
   - 各コンポーネントのimport文を更新
   - 必要に応じてプロパティ名の調整

3. **Reduxスライスの型安全性向上**
   - 各スライスの型定義を見直し
   - `any`型の使用を削除

### フェーズ2: コンポーネント構造のリファクタリング（2-3週間）

1. **大規模コンポーネントの分割**
   - `app/(tabs)/library.tsx`の分割
   - `app/(tabs)/discover.tsx`の分割
   - `app/(tabs)/profile.tsx`の分割

2. **コンポーネントディレクトリ構造の再編成**
   - `components/common`の細分化
     - `buttons`, `inputs`, `feedback`, `displays`など
   - 機能別ディレクトリの拡充
     - `books`, `timer`, `quotes`, `notes`など

3. **ReadingTimerコンポーネントのリファクタリング**
   - タイマー表示部分とコントロール部分の分離
   - アニメーション処理の分離

### フェーズ3: サービスアーキテクチャの改善（2週間）

1. **サービスとReduxの連携改善**
   - TimerServiceのリファクタリング
   - BookServiceとの統合的なアーキテクチャ

2. **型安全なサービス呼び出し**
   - サービスメソッドの引数と戻り値の型定義

3. **テスト容易性の向上**
   - 依存関係の明確化
   - モックしやすい構造への改善

## 期待される効果

- コードの可読性と保守性の向上
- バグの発生率低下
- 開発効率の向上
- 拡張性の向上（新機能追加が容易に）

## 実装の優先順位

1. 型定義の整理統合（最も基盤的な部分）
2. 巨大コンポーネントの分割（保守性向上の即効性が高い）
3. Reduxとサービスの連携改善（アーキテクチャレベルの改善）

## リスクと緩和策

- **機能退行のリスク**: 段階的なリファクタリングと変更ごとのテスト
- **開発スケジュールへの影響**: フェーズごとの明確な期限設定
- **チーム間の認識齟齬**: ドキュメント化と設計レビュー

## 結論

ChapMarkアプリのリファクタリングは、短期的な開発効率よりも長期的な保守性と拡張性を重視して進めるべきです。特に型定義の統一と巨大コンポーネントの分割は、即効性の高い改善となります。段階的に実施することで、リスクを最小限に抑えながら継続的な改善を図ることができます。 