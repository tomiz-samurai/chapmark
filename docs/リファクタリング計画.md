# ChapMarkアプリ リファクタリング計画

## 1. コード構造の問題点

現在のプロジェクトコードには以下の問題点が見られます：

### 1.1 巨大なスクリーンコンポーネント
- `app/(tabs)/timer.tsx` (851行)
- `app/(tabs)/library.tsx` (789行)
- コンポーネントが大きすぎて管理が難しく、責任範囲も不明確です

### 1.2 型定義の重複と不一致
- `Book` インターフェースが複数の場所で定義されている：
  - `lib/types.ts`
  - `types/book.ts` 
  - `lib/services/BookService.ts`
- 型定義の不一致によりエラーが発生する可能性があります

### 1.3 any型の多用
- Redux状態へのアクセス時に型アサーションと`any`型を使用している箇所が多い
- 型安全性が損なわれています

### 1.4 コンポーネント構造の不整合
- `components/common`内に多くのコンポーネントが混在している
- 論理的なグループ分けがされていない

### 1.5 サービスとコンポーネントの連携
- `TimerService`などのサービスとコンポーネント間の責任分担が不明確
- Redux経由での複雑な連携が行われている

## 2. リファクタリング提案

### 2.1 スクリーンコンポーネントの分割

#### timer.tsxの分割
- `TimerScreen`: メインのタイマースクリーン
- `BookSelection`: 本の選択コンポーネント
- `TimerControls`: タイマーコントロールボタン
- `PageProgress`: ページ進捗入力コンポーネント
- `CompletionModal`: 完了モーダル

#### library.tsxの分割
- `LibraryScreen`: メインのライブラリスクリーン
- `BookGrid`: 本のグリッド表示
- `BookList`: 本のリスト表示
- `FilterBar`: フィルターコンポーネント
- `EmptyLibrary`: 空の状態表示コンポーネント

### 2.2 型定義の統一

- 共通の型定義を`types`ディレクトリに集約
- 以下のような階層構造を提案：
  ```
  types/
    ├── models/
    │   ├── book.ts
    │   ├── session.ts
    │   └── ...
    ├── store/
    │   ├── bookState.ts
    │   ├── timerState.ts
    │   └── ...
    └── index.ts
  ```

### 2.3 コンポーネント構造の再編成

```
components/
  ├── common/
  │   ├── buttons/
  │   │   ├── Button.tsx
  │   │   └── CategoryButton.tsx
  │   ├── inputs/
  │   │   ├── Input.tsx
  │   │   └── PageInput.tsx
  │   ├── feedback/
  │   │   ├── Loading.tsx
  │   │   ├── EmptyState.tsx
  │   │   └── ProgressBar.tsx
  │   └── displays/
  │       ├── Avatar.tsx
  │       └── NotificationBadge.tsx
  ├── books/
  │   ├── BookCard.tsx
  │   ├── BookSelector.tsx
  │   ├── BookGrid.tsx
  │   └── BookList.tsx
  ├── timer/
  │   ├── ReadingTimer.tsx
  │   ├── TimerControls.tsx
  │   └── GoalTimeSelector.tsx
  ├── modals/
  │   ├── Modal.tsx
  │   ├── QuickEntryModal.tsx
  │   └── CompletionModal.tsx
  └── layouts/
      ├── Header.tsx
      └── TabBar.tsx
```

### 2.4 Reduxの型安全性強化

- `useSelector`を型安全に使用するためのカスタムフック作成
  ```typescript
  export function useAppSelector<T>(selector: (state: RootState) => T): T {
    return useSelector<RootState, T>(selector);
  }
  ```

- `any`型の使用を避け、明示的な型付けを行う
- スライスの型定義を適切に設計し直す

### 2.5 サービスアーキテクチャの改善

- サービスとコンポーネント間の責任分担を明確化
- Reduxとサービスのやりとりをよりクリーンにするためのミドルウェアやカスタムフックの検討
- サービス間の依存関係を整理し、テスト容易性を向上させる

### 2.6 コンポーネントのリファクタリング優先順位

1. `ReadingTimer.tsx` - 最も複雑なコンポーネントの一つ
2. `app/(tabs)/timer.tsx` - 大きすぎるスクリーンコンポーネント
3. `app/(tabs)/library.tsx` - 同じく大きすぎるスクリーンコンポーネント
4. `components/common/BookCard.tsx` - 複数箇所で使用される重要なコンポーネント

## 3. 実装計画

### フェーズ1: 型定義の統一とRedux改善
- 統一された型定義システムの構築
- Redux型安全性の強化
- `any`型の削除

### フェーズ2: コンポーネント構造の再編成
- 提案したディレクトリ構造への移行
- 巨大コンポーネントの分割

### フェーズ3: サービスアーキテクチャの改善
- サービスと状態管理の連携改善
- 責任分担の明確化

各フェーズは段階的に実装し、リグレッションテストを行いながら進めることを推奨します。 