# ChapMarkアプリ リファクタリング進捗状況（更新版）

## フェーズ1: 型定義の統一と安全性向上（完了）

### 実施済み

1. **型定義の集約と整備**
   - ✅ 共通モデル型の作成・整備
     - `types/models/book.ts` - 書籍モデル
     - `types/models/session.ts` - 読書セッション
     - `types/models/quote.ts` - 引用投稿
     - `types/models/note.ts` - ノート
     - `types/models/timer.ts` - タイマー
   - ✅ インデックスファイルによる一元管理
     - `types/models/index.ts`
   - ✅ BookStatus型の統合（`lib/types.ts`と`types/models/book.ts`の不一致解消）

2. **Redux型安全性向上**
   - ✅ 型安全なカスタムフック作成
     - `useAppSelector` - 型情報を保持したままRedux状態にアクセス
     - `useAppDispatch` - 型情報を保持したままアクション発行
   - ✅ Reduxスライスの型参照更新
     - `bookSlice.ts`
     - `sessionSlice.ts`
     - `quoteSlice.ts`
     - `noteSlice.ts`
     - `timerSlice.ts`

3. **コンポーネント型更新**
   - ✅ `ReadingTimer` - 新しい型定義とカスタムフック使用
   - ✅ `BookSelector` - Book型参照更新
   - ✅ `TimerControls` - 新規作成
   - ✅ `PageProgress` - 新規作成
   - ✅ `CompletionModal` - 新規作成

## フェーズ2: コンポーネント構造のリファクタリング（進行中）

### 実施済み

1. **TimerScreenの改善**
   - ✅ タイマーコントロール部分の分離
   - ✅ ページ進捗部分の分離
   - ✅ 完了モーダルの分離
   - ✅ 本選択コンポーネントの改善（BookSelection）
   - ✅ カスタムフックによる状態管理のカプセル化
     - `useBookSelection` - 本の選択と管理に関するロジック
     - `useReadingSession` - 読書セッション完了と保存に関するロジック

2. **LibraryScreenのリファクタリング（最優先で完了）**
   - ✅ 型安全なprops・状態管理（useLibraryフック）
   - ✅ BookGrid/BookList/FilterBar/BookCard等の共通化・分割
   - ✅ バリデーション・エラー表示の共通化（Input, EmptyState活用）
   - ✅ スタイルの統一（StyleSheet.create＋テーマ変数）
   - ✅ 致命的エラー時のEmptyState表示・リトライ対応
   - ✅ linterエラーの解消
   - ✅ コードの再利用性・保守性・拡張性の向上

3. **ProfileScreenの改善**
   - ✅ 巨大なprofile.tsxを分割し、責務ごとに整理
     - `ProfileHeader`（ユーザー情報・編集ボタン）
     - `ProfileStats`（読了冊数・読書時間・読書中：国際化対応済み）
     - `ProfileSettingsList`（設定リスト）
     - `ProfileLogoutButton`（ログアウトボタン）
     - `ProfileVersionInfo`（バージョン表示）
   - ✅ `features/profile/`配下に機能単位で整理
   - ✅ 共通部品（Avatar, Button等）の活用
   - ✅ スタイルの統一（StyleSheet.create＋テーマ変数）
   - ✅ 型安全なprops受け渡し
   - ✅ 国際化対応（t関数で多言語対応）
   - ✅ importパス・型exportの整理

4. **DiscoverScreenの改善（新規追記）**
   - ✅ 巨大なdiscover.tsxを分割し、責務ごとに整理
     - `DiscoverCategoryBar`（カテゴリバー）
     - `RecommendedBooksSection`（おすすめ書籍）
     - `NewReleasesSection`（新着書籍）
     - `CollectionSection`（コレクションごとの書籍リスト）
   - ✅ 共通部品（BookCard, CollectionHeader, CategoryButton, EmptyState等）の活用
   - ✅ カスタムフックによるロジック分離（useDiscoverCategory, useDiscoverBooks）
   - ✅ スタイルの統一（StyleSheet.create＋テーマ変数）
   - ✅ 国際化対応（t関数で多言語対応）
   - ✅ 型安全なprops受け渡し
   - ✅ importパス・型exportの整理

5. **components/commonの再編成・運用ルール策定**
   - ✅ サブディレクトリ構造の作成・整理
     - `buttons/`, `inputs/`, `feedback/`, `displays/`, `modals/`, `timers/` など
   - ✅ 既存コンポーネントの再配置・importパス修正
   - ✅ `components/common/index.ts`による一括エクスポート
   - ✅ 運用ルール・方針ドキュメントの作成（`docs/リファクタリング方針.md`）
   - ✅ ルール：「新規共通コンポーネントはcommon/配下の適切なサブディレクトリに追加」「importはcomponents/common経由で統一」等を明文化

### 今後の作業

1. **その他の大規模コンポーネントの分割**
   - ~~📋 discoverスクリーン~~（完了）
   - ~~📋 profileスクリーン~~（完了）

## フェーズ3: サービスアーキテクチャの改善（進行中）

### 実施済み

1. **TimerServiceのRedux経由統一**
   - ✅ タイマーの開始・停止・リセット・進捗更新など、全ての状態管理・副作用をReduxアクション/Thunk経由に統一
   - ✅ UIやカスタムフックからTimerServiceを直接呼ぶことはなくなり、Reduxのdispatchのみでタイマー制御が完結
   - ✅ 計算系ユーティリティ（formatTime, calculateProgress等）は副作用がないため個別importで運用

2. **NotificationServiceのRedux経由統一**
   - ✅ 通知送信（例: 目標達成時の通知）はReduxの非同期Thunk（notifyGoalReachedAsync）経由でdispatchされるようにリファクタリング
   - ✅ completeReadingSessionAsyncなどの非同期処理の中で「通知→状態更新」の流れがReduxのアクションフローに統一

3. **BookServiceとTimerServiceの連携・責務明確化**
   - ✅ 読書セッション完了時の一元管理（completeReadingSessionAsyncのリファクタ）
     - 本の進捗・ステータス更新（completed）
     - タイマー停止
     - 通知
     - これらを一括で管理し、UI/フックからはこのThunkのみdispatchすればOK
   - ✅ 読書セッション開始時の一元管理（startReadingSessionAsyncの新設）
     - 本のステータスを「reading」に
     - タイマー開始
     - これらを一括で管理し、UI/コンポーネントからはこのThunkのみdispatchすればOK
   - ✅ UI/コンポーネントの責務整理
     - ReadingTimerなどで、個別のサービス呼び出しや状態更新を廃止
     - Thunk（ユースケース単位）を呼ぶだけのシンプルな構造に

### 設計方針・メリット
- 状態管理・副作用（通知）ともにRedux経由に統一し、設計の一貫性・保守性・テスト容易性が大幅に向上
- 今後新たな副作用やサービスを追加する場合も、Reduxのアクション/Thunk経由で統一する方針

### 今後の作業
- BookServiceとTimerServiceの連携方法のさらなる見直し
- 旧型定義を参照している箇所の完全移行
- その他サービス層の副作用もRedux経由に統一

## 次のアクション（優先順位順）

1. **その他のスクリーンコンポーネントのリファクタリング**
   - ~~discoverスクリーン~~（完了）
   - ~~profileスクリーン~~（完了）

2. **サービスアーキテクチャの改善の検討**
   - BookServiceとTimerServiceの連携方法の見直し
   - 型の統一と整備の完了

## 成果

1. **コードの可読性向上**
   - 大きなコンポーネントが小さな責任範囲の明確なコンポーネントに分割
   - 状態管理ロジックがカスタムフックに抽出され、コンポーネントがシンプルに
   - **LibraryScreenは最優先でリファクタリング完了。全要件（型安全・共通化・分割・バリデーション・エラー表示・スタイル統一・linterエラー解消）を満たす状態に**

2. **再利用性の向上**
   - 共通コンポーネントの抽出により、他の画面での再利用が容易に
   - カスタムフックによる共通ロジックの再利用

3. **保守性の向上**
   - モジュール間の依存関係が明確に
   - バグ修正や機能追加が容易に

4. **型安全性の向上**
   - Redux状態へのアクセスが型安全に
   - コンポーネント間のデータの受け渡しが型検証される

- **ユースケース単位での一元管理**
  - 保守性・拡張性・テスト容易性が大幅に向上
- **サービス層の責務明確化**
  - 状態管理はRedux、永続化/APIはサービス層
- **UI/フックのシンプル化**
  - 再利用性・可読性アップ

## 注意事項・懸念点

- 型定義変更に伴う他コンポーネントへの影響
- 旧型定義を参照している箇所がまだ多く残っている
- コンポーネント分割に伴うprops受け渡しの複雑化の可能性

## 次のアクション

1. 残りのコンポーネント型更新を継続
2. Library画面のリファクタリングを開始
3. components/common内のサブディレクトリ作成と再編成 